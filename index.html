<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA –¥–ª—è iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trip Planner">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1d1d1f">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è iOS -->
    <link rel="apple-touch-icon" href="./icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="./icons/icon-167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180.png">
    
    <title>Trip Planner</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>">
    
    <style>
        /* === –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò (Apple HIG inspired) === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #8e8e93;
            --text-tertiary: #aeaeb2;
            --border: #e5e5ea;
            --accent: #007aff;
            --accent-light: #e3f2fd;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            overflow-x: hidden;
        }
        
        /* === –¢–û–ù–ö–ò–ô –•–ï–î–ï–† === */
        .header {
            background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 10px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 0.5px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 44px;
        }
        
        .header-back {
            font-size: 17px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
        }
        
        .header-back:active {
            opacity: 0.5;
        }
        
        .header-title {
            font-size: 17px;
            font-weight: 600;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .header-action {
            font-size: 17px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 0;
        }
        
        .header-action:active {
            opacity: 0.5;
        }
        
        /* === –ö–û–ù–¢–ï–ù–¢ === */
        .content {
            padding: 16px;
            padding-bottom: 100px;
        }
        
        /* === –°–ï–ö–¶–ò–Ø –° –ó–ê–ì–û–õ–û–í–ö–û–ú === */
        .section-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        
        .section-subheader {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 8px 4px;
        }
        
        /* === –ö–ê–†–¢–û–ß–ö–ê –ü–û–ï–ó–î–ö–ò === */
        .trip-card {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        .trip-card-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        
        .trip-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .trip-card-content {
            padding: 12px 14px;
        }
        
        .trip-card-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .trip-card-dates {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .trip-card-status {
            display: inline-block;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            margin-top: 8px;
        }
        
        .trip-card-status.upcoming {
            background: var(--accent-light);
            color: var(--accent);
        }
        
        .trip-card-status.current {
            background: #e8f5e9;
            color: #34c759;
        }
        
        .trip-card-status.past {
            background: #f0f0f5;
            color: var(--text-secondary);
        }
        
        /* === –°–ü–ò–°–û–ö === */
        .list {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            border-bottom: 0.5px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:active {
            background: var(--bg);
        }
        
        .list-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .list-item-icon.map { background: #e8f5e9; }
        .list-item-icon.instagram { background: #fce4ec; }
        .list-item-icon.web { background: #e3f2fd; }
        .list-item-icon.event { background: #fff3e0; }
        .list-item-icon.note { background: #f3e5f5; }
        .list-item-icon.photo { background: #e0f7fa; }
        
        .list-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .list-item-title {
            font-size: 16px;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .list-item-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .list-item-arrow {
            color: var(--text-tertiary);
            font-size: 14px;
            margin-left: 8px;
        }
        
        .list-item-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 8px;
            flex-shrink: 0;
        }
        
        /* === –°–û–ë–´–¢–ò–ï –í –ö–ê–õ–ï–ù–î–ê–†–ï === */
        .event-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 14px;
            border-bottom: 0.5px solid var(--border);
        }
        
        .event-item:last-child {
            border-bottom: none;
        }
        
        .event-time {
            width: 50px;
            font-size: 14px;
            font-weight: 500;
            color: var(--accent);
            flex-shrink: 0;
        }
        
        .event-content {
            flex: 1;
        }
        
        .event-title {
            font-size: 16px;
            font-weight: 400;
        }
        
        .event-note {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* === DAY HEADER === */
        .day-header {
            display: flex;
            align-items: center;
            padding: 12px 4px;
            margin-top: 16px;
        }
        
        .day-date {
            width: 44px;
            height: 44px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        
        .day-date-num {
            font-size: 18px;
            font-weight: 700;
            line-height: 1;
        }
        
        .day-date-month {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .day-title {
            font-size: 17px;
            font-weight: 600;
        }
        
        .day-weekday {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* === FAB (Floating Action Button) === */
        .fab-container {
            position: fixed;
            bottom: calc(24px + var(--safe-bottom));
            right: 20px;
            z-index: 200;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab.open {
            transform: rotate(45deg);
        }
        
        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        
        .fab-menu.open {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .fab-item-label {
            background: var(--card);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .fab-item-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--card);
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        .fab-item-btn:active {
            transform: scale(0.95);
        }
        
        /* === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê === */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--card);
            border-radius: 14px 14px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modal-handle {
            width: 36px;
            height: 5px;
            background: var(--border);
            border-radius: 3px;
            margin: 8px auto;
        }
        
        .modal-header {
            padding: 12px 16px;
            border-bottom: 0.5px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 17px;
            font-weight: 600;
        }
        
        .modal-close {
            font-size: 17px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 16px;
            padding-bottom: calc(16px + var(--safe-bottom));
        }
        
        /* === –§–û–†–ú–´ === */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            padding-left: 4px;
        }
        
        .input {
            width: 100%;
            padding: 12px 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
        }
        
        .input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        
        .input::placeholder {
            color: var(--text-tertiary);
        }
        
        textarea.input {
            resize: vertical;
            min-height: 80px;
        }
        
        /* === –ö–ù–û–ü–ö–ò === */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:active {
            opacity: 0.8;
        }
        
        .btn-secondary {
            background: var(--bg);
            color: var(--text);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-text {
            background: none;
            color: var(--accent);
            padding: 8px;
        }
        
        /* === –°–ï–ì–ú–ï–ù–¢–ù–´–ô –ö–û–ù–¢–†–û–õ–¨ === */
        .segment-control {
            display: flex;
            background: var(--bg);
            border-radius: 10px;
            padding: 2px;
            margin-bottom: 16px;
        }
        
        .segment-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .segment-btn.active {
            background: var(--card);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        /* === –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-text {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* === –§–û–¢–û –ì–ê–õ–ï–†–ï–Ø === */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            margin-top: 12px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            background: var(--bg);
            overflow: hidden;
            cursor: pointer;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-add {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-tertiary);
            border: 2px dashed var(--border);
        }
        
        /* === –°–°–´–õ–ö–ê –ü–†–ï–í–¨–Æ === */
        .link-preview {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .link-preview-content {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .link-favicon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .link-info {
            flex: 1;
            min-width: 0;
        }
        
        .link-title {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-url {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .toast {
            position: fixed;
            top: calc(60px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--text);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* === PHOTO PICKER === */
        .photo-picker {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed var(--border);
            overflow: hidden;
        }
        
        .photo-picker:active {
            opacity: 0.7;
        }
        
        /* === –£–¢–ò–õ–ò–¢–´ === */
        .hidden { display: none !important; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .text-secondary { color: var(--text-secondary); }
        
        /* === –û–ü–ò–°–ê–ù–ò–ï === */
        .description-block {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }
        
        .description-text {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text);
            white-space: pre-wrap;
        }
        
        /* === TAB BAR –î–õ–Ø –î–ï–¢–ê–õ–ï–ô –ü–û–ï–ó–î–ö–ò === */
        .tab-bar {
            display: flex;
            background: var(--card);
            border-bottom: 0.5px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-bar::-webkit-scrollbar {
            display: none;
        }
        
        .tab-item {
            flex-shrink: 0;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border: none;
            background: none;
            cursor: pointer;
            position: relative;
        }
        
        .tab-item.active {
            color: var(--accent);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 16px;
            right: 16px;
            height: 2px;
            background: var(--accent);
            border-radius: 1px;
        }
        
        /* === COVER IMAGE PICKER === */
        .cover-picker {
            width: 100%;
            height: 180px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }
        
        .cover-picker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cover-picker-text {
            color: white;
            font-size: 15px;
            font-weight: 500;
        }
        
        .cover-picker-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .cover-picker-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .cover-picker:hover .cover-picker-overlay,
        .cover-picker:active .cover-picker-overlay {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- –•–µ–¥–µ—Ä -->
    <header class="header" id="header">
        <button class="header-back hidden" id="headerBack" onclick="App.goBack()">
            ‚Äπ –ù–∞–∑–∞–¥
        </button>
        <span class="header-title" id="headerTitle">–ü–æ–µ–∑–¥–∫–∏</span>
        <button class="header-action hidden" id="headerAction"></button>
    </header>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="content" id="mainContent">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </main>
    
    <!-- FAB —Å –º–µ–Ω—é -->
    <div class="fab-container" id="fabContainer">
        <div class="fab-menu" id="fabMenu">
            <!-- FAB –º–µ–Ω—é –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <button class="fab" id="fabBtn" onclick="App.toggleFab()">+</button>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent">
            <div class="modal-handle"></div>
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
        </div>
    </div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="toast" id="toast"></div>

<script>
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë                         TRIP PLANNER - –Ø–î–†–û                                ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

class TripPlannerApp {
    constructor() {
        this.db = null;
        this.currentView = 'trips'; // trips | tripDetail | addTrip
        this.currentTrip = null;
        this.currentTab = 'schedule'; // schedule | links | notes | photos
        this.fabOpen = false;
        
        this.dom = {
            content: document.getElementById('mainContent'),
            header: document.getElementById('header'),
            headerBack: document.getElementById('headerBack'),
            headerTitle: document.getElementById('headerTitle'),
            headerAction: document.getElementById('headerAction'),
            fabContainer: document.getElementById('fabContainer'),
            fabBtn: document.getElementById('fabBtn'),
            fabMenu: document.getElementById('fabMenu'),
            modal: document.getElementById('modalOverlay'),
            modalContent: document.getElementById('modalContent'),
            toast: document.getElementById('toast')
        };
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async init() {
        console.log('üß≥ Trip Planner: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        
        // Telegram Web App
        this.initTelegram();
        
        await this.initDatabase();
        this.renderTrips();
        this.registerServiceWorker();
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
        this.dom.modal.onclick = (e) => {
            if (e.target === this.dom.modal) this.closeModal();
        };
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ FAB –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if (this.fabOpen && !this.dom.fabContainer.contains(e.target)) {
                this.closeFab();
            }
        });
        
        console.log('‚úÖ Trip Planner –≥–æ—Ç–æ–≤!');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TELEGRAM INTEGRATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    initTelegram() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –≤ Telegram
        if (!window.Telegram?.WebApp) {
            console.log('üì± –û—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram (–±—Ä–∞—É–∑–µ—Ä)');
            this.telegramUser = null;
            return;
        }
        
        const tg = window.Telegram.WebApp;
        
        // –°–æ–æ–±—â–∞–µ–º Telegram —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        tg.ready();
        
        // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.expand();
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = tg.initDataUnsafe?.user;
        
        if (user) {
            this.telegramUser = {
                id: user.id,
                firstName: user.first_name,
                lastName: user.last_name || '',
                username: user.username || null
            };
            
            console.log('üë§ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', this.telegramUser);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –≤ Google Sheets
            this.logToGoogleSheets('open', this.telegramUser);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            // this.checkWhitelist();
        } else {
            console.log('üì± Telegram: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω');
            this.telegramUser = null;
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        this.applyTelegramTheme(tg.colorScheme);
    }
    
    applyTelegramTheme(colorScheme) {
        if (colorScheme === 'dark') {
            document.documentElement.style.setProperty('--bg', '#1c1c1e');
            document.documentElement.style.setProperty('--card', '#2c2c2e');
            document.documentElement.style.setProperty('--text', '#ffffff');
            document.documentElement.style.setProperty('--text-secondary', '#8e8e93');
            document.documentElement.style.setProperty('--border', '#3a3a3c');
        }
    }
    
    // –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –∏ –∑–∞–ø–æ–ª–Ω–∏ ID)
    checkWhitelist() {
        const ALLOWED_USERS = [
            // –í–ø–∏—à–∏ —Å—é–¥–∞ Telegram ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
            // 123456789,
            // 987654321,
        ];
        
        if (ALLOWED_USERS.length === 0) return; // –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π ‚Äî –¥–æ—Å—Ç—É–ø –≤—Å–µ–º
        
        if (!this.telegramUser || !ALLOWED_USERS.includes(this.telegramUser.id)) {
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100vh;
                    padding: 40px;
                    text-align: center;
                    background: var(--bg);
                    color: var(--text);
                ">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚õî</div>
                    <h2 style="margin-bottom: 12px;">–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç</h2>
                    <p style="color: var(--text-secondary);">–≠—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–µ–∑–¥–∫–∏</p>
                    ${this.telegramUser ? `<p style="margin-top: 20px; font-size: 12px; opacity: 0.5;">–í–∞—à ID: ${this.telegramUser.id}</p>` : ''}
                </div>
            `;
            throw new Error('Access denied');
        }
    }
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Google Sheets
    // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò URL –Ω–∞ —Å–≤–æ–π (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∏–∂–µ)
    async logToGoogleSheets(action, user) {
        const GOOGLE_SCRIPT_URL = ''; // –°—é–¥–∞ –≤—Å—Ç–∞–≤—å URL –∏–∑ Google Apps Script
        
        if (!GOOGLE_SCRIPT_URL) {
            console.log('üìä Google Sheets: URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            return;
        }
        
        try {
            const data = {
                timestamp: new Date().toISOString(),
                action: action,
                userId: user?.id || 'unknown',
                firstName: user?.firstName || '',
                lastName: user?.lastName || '',
                username: user?.username || ''
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            console.log('üìä –õ–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Google Sheets');
        } catch (error) {
            console.log('üìä –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ë–ê–ó–ê –î–ê–ù–ù–´–•
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async initDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('TripPlannerDB', 1);
            
            request.onerror = () => reject(request.error);
            
            request.onsuccess = () => {
                this.db = request.result;
                console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞');
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // –ü–æ–µ–∑–¥–∫–∏
                if (!db.objectStoreNames.contains('trips')) {
                    const store = db.createObjectStore('trips', { keyPath: 'id' });
                    store.createIndex('startDate', 'startDate', { unique: false });
                }
                
                // –°–æ–±—ã—Ç–∏—è (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ)
                if (!db.objectStoreNames.contains('events')) {
                    const store = db.createObjectStore('events', { keyPath: 'id' });
                    store.createIndex('tripId', 'tripId', { unique: false });
                    store.createIndex('date', 'date', { unique: false });
                }
                
                // –°—Å—ã–ª–∫–∏
                if (!db.objectStoreNames.contains('links')) {
                    const store = db.createObjectStore('links', { keyPath: 'id' });
                    store.createIndex('tripId', 'tripId', { unique: false });
                }
                
                // –ó–∞–º–µ—Ç–∫–∏
                if (!db.objectStoreNames.contains('notes')) {
                    const store = db.createObjectStore('notes', { keyPath: 'id' });
                    store.createIndex('tripId', 'tripId', { unique: false });
                }
                
                // –§–æ—Ç–æ (base64)
                if (!db.objectStoreNames.contains('photos')) {
                    const store = db.createObjectStore('photos', { keyPath: 'id' });
                    store.createIndex('tripId', 'tripId', { unique: false });
                }
            };
        });
    }
    
    async dbSave(store, data) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            const s = tx.objectStore(store);
            const req = s.put(data);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }
    
    async dbGet(store, id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const s = tx.objectStore(store);
            const req = s.get(id);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }
    
    async dbGetAll(store, indexName = null, query = null) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readonly');
            const s = tx.objectStore(store);
            const target = indexName ? s.index(indexName) : s;
            const req = query !== null ? target.getAll(query) : target.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => reject(req.error);
        });
    }
    
    async dbDelete(store, id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            const s = tx.objectStore(store);
            const req = s.delete(id);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    }
    
    async dbClear(store) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction(store, 'readwrite');
            const s = tx.objectStore(store);
            const req = s.clear();
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ù–ê–í–ò–ì–ê–¶–ò–Ø
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    goBack() {
        if (this.currentView === 'tripDetail') {
            this.renderTrips();
        }
    }
    
    updateHeader(title, showBack = false, actionBtn = null) {
        this.dom.headerTitle.textContent = title;
        this.dom.headerBack.classList.toggle('hidden', !showBack);
        
        if (actionBtn) {
            this.dom.headerAction.textContent = actionBtn.text;
            this.dom.headerAction.onclick = actionBtn.onClick;
            this.dom.headerAction.classList.remove('hidden');
        } else {
            this.dom.headerAction.classList.add('hidden');
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FAB –ú–ï–ù–Æ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    toggleFab() {
        this.fabOpen ? this.closeFab() : this.openFab();
    }
    
    openFab() {
        this.fabOpen = true;
        this.dom.fabBtn.classList.add('open');
        this.dom.fabMenu.classList.add('open');
    }
    
    closeFab() {
        this.fabOpen = false;
        this.dom.fabBtn.classList.remove('open');
        this.dom.fabMenu.classList.remove('open');
    }
    
    updateFabMenu(items) {
        this.dom.fabMenu.innerHTML = items.map(item => `
            <div class="fab-item">
                <span class="fab-item-label">${item.label}</span>
                <button class="fab-item-btn" onclick="App.closeFab(); ${item.action}">${item.icon}</button>
            </div>
        `).join('');
    }
    
    hideFab() {
        this.dom.fabContainer.classList.add('hidden');
    }
    
    showFab() {
        this.dom.fabContainer.classList.remove('hidden');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –°–ü–ò–°–û–ö –ü–û–ï–ó–î–û–ö
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderTrips() {
        this.currentView = 'trips';
        this.currentTrip = null;
        this.updateHeader('–ü–æ–µ–∑–¥–∫–∏');
        
        this.updateFabMenu([
            { label: '–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞', icon: '‚úàÔ∏è', action: 'App.showAddTripModal()' },
            { label: '–ò–º–ø–æ—Ä—Ç JSON', icon: 'üì•', action: 'App.importData()' },
            { label: '–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–≥–æ', icon: 'üì§', action: 'App.exportAllData()' }
        ]);
        this.showFab();
        
        const trips = await this.dbGetAll('trips');
        
        if (trips.length === 0) {
            this.dom.content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üß≥</div>
                    <div class="empty-title">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</div>
                    <div class="empty-text">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ</div>
                </div>
            `;
            return;
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–µ–π—á–∞—Å, –±—É–¥—É—â–∏–µ, –ø—Ä–æ—à–ª—ã–µ
        const today = new Date().toISOString().split('T')[0];
        
        // –°–µ–π—á–∞—Å: startDate <= —Å–µ–≥–æ–¥–Ω—è –ò endDate >= —Å–µ–≥–æ–¥–Ω—è
        const current = trips.filter(t => t.startDate <= today && t.endDate >= today)
            .sort((a, b) => a.endDate.localeCompare(b.endDate));
        
        // –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ: startDate > —Å–µ–≥–æ–¥–Ω—è
        const upcoming = trips.filter(t => t.startDate > today)
            .sort((a, b) => a.startDate.localeCompare(b.startDate));
        
        // –ü—Ä–æ—à–ª—ã–µ: endDate < —Å–µ–≥–æ–¥–Ω—è
        const past = trips.filter(t => t.endDate < today)
            .sort((a, b) => b.startDate.localeCompare(a.startDate));
        
        let html = '';
        
        if (current.length > 0) {
            html += `<div class="section-subheader">‚úàÔ∏è –°–µ–π—á–∞—Å</div>`;
            html += current.map(t => this.renderTripCard(t, 'current')).join('');
        }
        
        if (upcoming.length > 0) {
            html += `<div class="section-subheader">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>`;
            html += upcoming.map(t => this.renderTripCard(t, 'upcoming')).join('');
        }
        
        if (past.length > 0) {
            html += `<div class="section-subheader">–ü—Ä–æ—à–ª—ã–µ</div>`;
            html += past.map(t => this.renderTripCard(t, 'past')).join('');
        }
        
        this.dom.content.innerHTML = html;
    }
    
    renderTripCard(trip, status) {
        const dates = this.formatDateRange(trip.startDate, trip.endDate);
        const statusLabels = { 
            current: '–í –ø–æ–µ–∑–¥–∫–µ', 
            upcoming: '–°–∫–æ—Ä–æ', 
            past: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' 
        };
        const statusLabel = statusLabels[status];
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const gradients = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
        ];
        const gradientIndex = trip.title.length % gradients.length;
        const gradient = gradients[gradientIndex];
        const emoji = this.getTripEmoji(trip.title);
        
        const coverHtml = trip.cover 
            ? `<div class="trip-card-image" style="background-image: url('${trip.cover}'); background-size: cover; background-position: center;"></div>`
            : `<div class="trip-card-image" style="background: ${gradient};">
                   <span style="font-size: 56px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">${emoji}</span>
               </div>`;
        
        return `
            <div class="trip-card" onclick="App.openTrip('${trip.id}')">
                ${coverHtml}
                <div class="trip-card-content">
                    <div class="trip-card-title">${trip.title}</div>
                    <div class="trip-card-dates">${dates}</div>
                    <span class="trip-card-status ${status}">${statusLabel}</span>
                </div>
            </div>
        `;
    }
    
    getTripEmoji(title) {
        const lower = title.toLowerCase();
        if (lower.includes('–ø–ª—è–∂') || lower.includes('–º–æ—Ä–µ') || lower.includes('ocean')) return 'üèñÔ∏è';
        if (lower.includes('–≥–æ—Ä') || lower.includes('mountain') || lower.includes('–∞–ª—å–ø')) return 'üèîÔ∏è';
        if (lower.includes('–ø–∞—Ä–∏–∂') || lower.includes('paris')) return 'üóº';
        if (lower.includes('—Ä–∏–º') || lower.includes('rome') || lower.includes('–∏—Ç–∞–ª')) return 'üèõÔ∏è';
        if (lower.includes('–ª–æ–Ω–¥–æ–Ω') || lower.includes('london')) return 'üé°';
        if (lower.includes('–Ω—å—é-–π–æ—Ä–∫') || lower.includes('new york')) return 'üóΩ';
        if (lower.includes('—Ç–æ–∫–∏–æ') || lower.includes('tokyo') || lower.includes('—è–ø–æ–Ω')) return 'üóæ';
        if (lower.includes('–±–∞—Ä—Å–µ–ª–æ–Ω') || lower.includes('–∏—Å–ø–∞–Ω')) return 'üá™üá∏';
        if (lower.includes('—Å—Ç–∞–º–±—É–ª') || lower.includes('—Ç—É—Ä—Ü')) return 'üïå';
        if (lower.includes('–¥—É–±–∞–π') || lower.includes('dubai')) return 'üèôÔ∏è';
        if (lower.includes('—Ç–∞–π–ª–∞–Ω–¥') || lower.includes('thai') || lower.includes('–±–∞–ª–∏')) return 'üå¥';
        if (lower.includes('–≥—Ä–µ—Ü–∏') || lower.includes('greece') || lower.includes('–∞—Ñ–∏–Ω')) return 'üè∫';
        if (lower.includes('–µ–≥–∏–ø–µ—Ç') || lower.includes('egypt')) return 'üê™';
        if (lower.includes('–ª–µ—Å') || lower.includes('–ø—Ä–∏—Ä–æ–¥') || lower.includes('–∫–µ–º–ø–∏–Ω–≥')) return 'üèïÔ∏è';
        if (lower.includes('–æ–∑–µ—Ä') || lower.includes('lake')) return 'üèûÔ∏è';
        if (lower.includes('–∫—Ä—É–∏–∑') || lower.includes('cruise') || lower.includes('–∫–æ—Ä–∞–±–ª')) return 'üö¢';
        if (lower.includes('–ø–æ—Ö–æ–¥') || lower.includes('hik')) return 'ü•æ';
        if (lower.includes('–ª—ã–∂') || lower.includes('ski') || lower.includes('—Å–Ω–µ–≥')) return '‚õ∑Ô∏è';
        if (lower.includes('—Å–∞—Ñ–∞—Ä–∏') || lower.includes('safari')) return 'ü¶Å';
        return '‚úàÔ∏è';
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–û–ï–ó–î–ö–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    showAddTripModal() {
        this.showModal({
            title: '–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞',
            body: `
                <div class="cover-picker" id="coverPicker" onclick="App.pickCover()">
                    <span class="cover-picker-icon">üì∑</span>
                    <span class="cover-picker-text">–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É</span>
                </div>
                <input type="hidden" id="tripCover">
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="input" id="tripTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∞—Ä–∏–∂ 2025">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input type="date" class="input" id="tripStart">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" class="input" id="tripEnd">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea class="input" id="tripDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="App.saveTrip()">–°–æ–∑–¥–∞—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
            `
        });
    }
    
    pickCover() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const base64 = await this.fileToBase64(file);
            document.getElementById('tripCover').value = base64;
            document.getElementById('coverPicker').innerHTML = `
                <img src="${base64}">
                <div class="cover-picker-overlay">
                    <span class="cover-picker-icon">üì∑</span>
                    <span class="cover-picker-text">–ò–∑–º–µ–Ω–∏—Ç—å</span>
                </div>
            `;
        };
        input.click();
    }
    
    async saveTrip() {
        const title = document.getElementById('tripTitle').value.trim();
        const start = document.getElementById('tripStart').value;
        const end = document.getElementById('tripEnd').value;
        const desc = document.getElementById('tripDesc').value.trim();
        const cover = document.getElementById('tripCover').value;
        
        if (!title) {
            this.showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
            return;
        }
        if (!start || !end) {
            this.showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã', 'error');
            return;
        }
        
        const trip = {
            id: this.generateId(),
            title,
            startDate: start,
            endDate: end,
            description: desc,
            cover: cover || null,
            created: new Date().toISOString()
        };
        
        await this.dbSave('trips', trip);
        this.closeModal();
        this.showToast('‚úàÔ∏è –ü–æ–µ–∑–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
        this.renderTrips();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –î–ï–¢–ê–õ–ò –ü–û–ï–ó–î–ö–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async openTrip(tripId) {
        const trip = await this.dbGet('trips', tripId);
        if (!trip) return;
        
        this.currentView = 'tripDetail';
        this.currentTrip = trip;
        this.currentTab = 'schedule';
        
        this.updateHeader(trip.title, true, {
            text: '¬∑¬∑¬∑',
            onClick: () => this.showTripMenu()
        });
        
        this.renderTripDetail();
    }
    
    async renderTripDetail() {
        const trip = this.currentTrip;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º FAB –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏
        this.updateFabForTab();
        
        // –¢–∞–±—ã
        const tabs = `
            <div class="tab-bar">
                <button class="tab-item ${this.currentTab === 'schedule' ? 'active' : ''}" onclick="App.switchTab('schedule')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                <button class="tab-item ${this.currentTab === 'links' ? 'active' : ''}" onclick="App.switchTab('links')">–°—Å—ã–ª–∫–∏</button>
                <button class="tab-item ${this.currentTab === 'notes' ? 'active' : ''}" onclick="App.switchTab('notes')">–ó–∞–º–µ—Ç–∫–∏</button>
                <button class="tab-item ${this.currentTab === 'photos' ? 'active' : ''}" onclick="App.switchTab('photos')">–§–æ—Ç–æ</button>
            </div>
        `;
        
        let content = '';
        
        switch (this.currentTab) {
            case 'schedule':
                content = await this.renderScheduleTab();
                break;
            case 'links':
                content = await this.renderLinksTab();
                break;
            case 'notes':
                content = await this.renderNotesTab();
                break;
            case 'photos':
                content = await this.renderPhotosTab();
                break;
        }
        
        this.dom.content.innerHTML = tabs + `<div style="padding: 16px;">${content}</div>`;
    }
    
    switchTab(tab) {
        this.currentTab = tab;
        this.renderTripDetail();
    }
    
    updateFabForTab() {
        const items = [];
        
        switch (this.currentTab) {
            case 'schedule':
                items.push({ label: '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ', icon: 'üìÖ', action: 'App.showAddEventModal()' });
                break;
            case 'links':
                items.push({ label: 'Google Maps', icon: 'üó∫Ô∏è', action: "App.showAddLinkModal('map')" });
                items.push({ label: '–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã', icon: 'üìç', action: "App.showAddLinkModal('yandex')" });
                items.push({ label: 'Instagram', icon: 'üì∏', action: "App.showAddLinkModal('instagram')" });
                items.push({ label: '–°–∞–π—Ç', icon: 'üåê', action: "App.showAddLinkModal('web')" });
                break;
            case 'notes':
                items.push({ label: '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É', icon: 'üìù', action: 'App.showAddNoteModal()' });
                break;
            case 'photos':
                items.push({ label: '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ', icon: 'üì∑', action: 'App.addPhoto()' });
                break;
        }
        
        items.push({ label: '–≠–∫—Å–ø–æ—Ä—Ç –≤ HTML', icon: 'üåê', action: 'App.exportTripHTML()' });
        items.push({ label: '–≠–∫—Å–ø–æ—Ä—Ç JSON', icon: 'üì§', action: 'App.exportTrip()' });
        
        this.updateFabMenu(items);
        this.showFab();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –†–ê–°–ü–ò–°–ê–ù–ò–ï
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderScheduleTab() {
        const events = await this.dbGetAll('events', 'tripId', this.currentTrip.id);
        
        if (events.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <div class="empty-title">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>
                    <div class="empty-text">–î–æ–±–∞–≤—å—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                </div>
            `;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
        const grouped = {};
        events.forEach(e => {
            if (!grouped[e.date]) grouped[e.date] = [];
            grouped[e.date].push(e);
        });
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞—Ç
        const sortedDates = Object.keys(grouped).sort();
        
        let html = '';
        sortedDates.forEach(date => {
            const dayEvents = grouped[date].sort((a, b) => a.time.localeCompare(b.time));
            const dateObj = new Date(date);
            
            html += `
                <div class="day-header">
                    <div class="day-date">
                        <span class="day-date-num">${dateObj.getDate()}</span>
                        <span class="day-date-month">${this.getMonthShort(dateObj.getMonth())}</span>
                    </div>
                    <div>
                        <div class="day-title">${this.getWeekday(dateObj)}</div>
                        <div class="day-weekday">${this.formatDate(date)}</div>
                    </div>
                </div>
                <div class="list">
                    ${dayEvents.map(e => `
                        <div class="event-item" onclick="App.showEventDetail('${e.id}')">
                            <span class="event-time">${e.time}</span>
                            <div class="event-content">
                                <div class="event-title">
                                    ${e.title}
                                    ${e.link ? '<span style="margin-left: 6px; opacity: 0.6;">üîó</span>' : ''}
                                    ${e.photo ? '<span style="margin-left: 4px; opacity: 0.6;">üì∑</span>' : ''}
                                </div>
                                ${e.note ? `<div class="event-note">${e.note}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        });
        
        return html;
    }
    
    showAddEventModal() {
        this.showModal({
            title: '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
            body: `
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞</label>
                    <input type="date" class="input" id="eventDate" 
                        min="${this.currentTrip.startDate}" 
                        max="${this.currentTrip.endDate}"
                        value="${this.currentTrip.startDate}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í—Ä–µ–º—è</label>
                    <input type="time" class="input" id="eventTime" value="10:00">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="input" id="eventTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–≤—Ç—Ä–∞–∫ –≤ –æ—Ç–µ–ª–µ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ó–∞–º–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea class="input" id="eventNote" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–°—Å—ã–ª–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="url" class="input" id="eventLink" placeholder="https://maps.google.com/... –∏–ª–∏ yandex.ru/maps/...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <div class="photo-picker" id="eventPhotoPicker" onclick="App.pickEventPhoto()">
                        <span style="font-size: 24px; color: var(--text-tertiary);">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                    </div>
                    <input type="hidden" id="eventPhoto">
                </div>
                
                <button class="btn btn-primary" onclick="App.saveEvent()">–î–æ–±–∞–≤–∏—Ç—å</button>
            `
        });
    }
    
    pickEventPhoto() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const base64 = await this.fileToBase64(file);
            document.getElementById('eventPhoto').value = base64;
            document.getElementById('eventPhotoPicker').innerHTML = `
                <img src="${base64}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            `;
        };
        input.click();
    }
    
    async saveEvent() {
        const date = document.getElementById('eventDate').value;
        const time = document.getElementById('eventTime').value;
        const title = document.getElementById('eventTitle').value.trim();
        const note = document.getElementById('eventNote').value.trim();
        const link = document.getElementById('eventLink').value.trim();
        const photo = document.getElementById('eventPhoto').value;
        
        if (!date || !time || !title) {
            this.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        const event = {
            id: this.generateId(),
            tripId: this.currentTrip.id,
            date,
            time,
            title,
            note,
            link: link || null,
            photo: photo || null
        };
        
        await this.dbSave('events', event);
        this.closeModal();
        this.showToast('üìÖ –°–æ–±—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
        this.renderTripDetail();
    }
    
    async showEventDetail(eventId) {
        const event = await this.dbGet('events', eventId);
        if (!event) return;
        
        let photoHtml = '';
        if (event.photo) {
            photoHtml = `<img src="${event.photo}" style="width: 100%; border-radius: 12px; margin-bottom: 16px;">`;
        }
        
        let linkHtml = '';
        if (event.link) {
            const linkIcon = event.link.includes('yandex') ? 'üìç' : (event.link.includes('google') || event.link.includes('goo.gl')) ? 'üó∫Ô∏è' : 'üîó';
            linkHtml = `
                <a href="${event.link}" target="_blank" class="btn btn-secondary mb-16" style="text-decoration: none;">
                    ${linkIcon} –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
                </a>
            `;
        }
        
        this.showModal({
            title: event.title,
            body: `
                ${photoHtml}
                
                <div class="description-block">
                    <p><strong>–î–∞—Ç–∞:</strong> ${this.formatDate(event.date)}</p>
                    <p><strong>–í—Ä–µ–º—è:</strong> ${event.time}</p>
                    ${event.note ? `<p style="margin-top: 12px">${event.note}</p>` : ''}
                </div>
                
                ${linkHtml}
                
                <button class="btn btn-secondary mb-16" onclick="App.showEditEventModal('${eventId}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                
                <button class="btn btn-danger" onclick="App.deleteEvent('${eventId}')">–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
            `
        });
    }
    
    async showEditEventModal(eventId) {
        const event = await this.dbGet('events', eventId);
        if (!event) return;
        
        this.showModal({
            title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ',
            body: `
                <input type="hidden" id="editEventId" value="${eventId}">
                
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞</label>
                    <input type="date" class="input" id="editEventDate" 
                        min="${this.currentTrip.startDate}" 
                        max="${this.currentTrip.endDate}"
                        value="${event.date}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í—Ä–µ–º—è</label>
                    <input type="time" class="input" id="editEventTime" value="${event.time}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="input" id="editEventTitle" value="${event.title}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label>
                    <textarea class="input" id="editEventNote">${event.note || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–°—Å—ã–ª–∫–∞</label>
                    <input type="url" class="input" id="editEventLink" value="${event.link || ''}" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–§–æ—Ç–æ</label>
                    <div class="photo-picker" id="editEventPhotoPicker" onclick="App.pickEditEventPhoto()">
                        ${event.photo 
                            ? `<img src="${event.photo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">`
                            : `<span style="font-size: 24px; color: var(--text-tertiary);">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>`
                        }
                    </div>
                    <input type="hidden" id="editEventPhoto" value="${event.photo || ''}">
                    <div id="removeEventPhotoBtn">
                        ${event.photo ? `<button type="button" class="btn btn-text" style="color: var(--danger); margin-top: 8px;" onclick="App.removeEventPhoto()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>` : ''}
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="App.updateEvent()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `
        });
    }
    
    removeEventPhoto() {
        document.getElementById('editEventPhoto').value = '';
        document.getElementById('editEventPhotoPicker').innerHTML = `
            <span style="font-size: 24px; color: var(--text-tertiary);">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
        `;
        document.getElementById('removeEventPhotoBtn').innerHTML = '';
        this.showToast('üóëÔ∏è –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
    }
    
    pickEditEventPhoto() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const base64 = await this.fileToBase64(file);
            document.getElementById('editEventPhoto').value = base64;
            document.getElementById('editEventPhotoPicker').innerHTML = `
                <img src="${base64}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            `;
        };
        input.click();
    }
    
    async updateEvent() {
        const eventId = document.getElementById('editEventId').value;
        const event = await this.dbGet('events', eventId);
        if (!event) return;
        
        event.date = document.getElementById('editEventDate').value;
        event.time = document.getElementById('editEventTime').value;
        event.title = document.getElementById('editEventTitle').value.trim();
        event.note = document.getElementById('editEventNote').value.trim();
        event.link = document.getElementById('editEventLink').value.trim() || null;
        event.photo = document.getElementById('editEventPhoto').value || null;
        
        if (!event.date || !event.time || !event.title) {
            this.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        await this.dbSave('events', event);
        this.closeModal();
        this.showToast('‚úÖ –°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        this.renderTripDetail();
    }
    
    async deleteEvent(eventId) {
        await this.dbDelete('events', eventId);
        this.closeModal();
        this.showToast('üóëÔ∏è –°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
        this.renderTripDetail();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –°–°–´–õ–ö–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderLinksTab() {
        const links = await this.dbGetAll('links', 'tripId', this.currentTrip.id);
        
        if (links.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-icon">üîó</div>
                    <div class="empty-title">–ù–µ—Ç —Å—Å—ã–ª–æ–∫</div>
                    <div class="empty-text">–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏: –∫–∞—Ä—Ç—ã, Instagram, —Å–∞–π—Ç—ã</div>
                </div>
            `;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø—É
        const maps = links.filter(l => l.type === 'map');
        const yandex = links.filter(l => l.type === 'yandex');
        const instagrams = links.filter(l => l.type === 'instagram');
        const webs = links.filter(l => l.type === 'web');
        
        let html = '';
        
        if (maps.length > 0) {
            html += `<div class="section-subheader">üó∫Ô∏è Google Maps</div>`;
            html += `<div class="list">${maps.map(l => this.renderLinkItem(l)).join('')}</div>`;
        }
        
        if (yandex.length > 0) {
            html += `<div class="section-subheader">üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</div>`;
            html += `<div class="list">${yandex.map(l => this.renderLinkItem(l)).join('')}</div>`;
        }
        
        if (instagrams.length > 0) {
            html += `<div class="section-subheader">üì∏ Instagram</div>`;
            html += `<div class="list">${instagrams.map(l => this.renderLinkItem(l)).join('')}</div>`;
        }
        
        if (webs.length > 0) {
            html += `<div class="section-subheader">üåê –°–∞–π—Ç—ã</div>`;
            html += `<div class="list">${webs.map(l => this.renderLinkItem(l)).join('')}</div>`;
        }
        
        return html;
    }
    
    renderLinkItem(link) {
        const icons = { map: 'üó∫Ô∏è', yandex: 'üìç', instagram: 'üì∏', web: 'üåê' };
        const iconClass = { map: 'map', yandex: 'map', instagram: 'instagram', web: 'web' };
        
        return `
            <div class="list-item" onclick="App.openLink('${link.id}')">
                <div class="list-item-icon ${iconClass[link.type]}">${icons[link.type]}</div>
                <div class="list-item-content">
                    <div class="list-item-title">${link.title}</div>
                    <div class="list-item-subtitle">${this.getDomain(link.url)}</div>
                </div>
                <span class="list-item-arrow">‚Ä∫</span>
            </div>
        `;
    }
    
    showAddLinkModal(type) {
        const titles = { map: 'Google Maps', yandex: '–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã', instagram: 'Instagram', web: '–°–∞–π—Ç' };
        const placeholders = {
            map: 'https://maps.google.com/...',
            yandex: 'https://yandex.ru/maps/...',
            instagram: 'https://instagram.com/...',
            web: 'https://example.com'
        };
        
        this.showModal({
            title: `–î–æ–±–∞–≤–∏—Ç—å: ${titles[type]}`,
            body: `
                <input type="hidden" id="linkType" value="${type}">
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="input" id="linkTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ—Å—Ç–æ—Ä–∞–Ω —É –º–æ—Ä—è">
                </div>
                
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" class="input" id="linkUrl" placeholder="${placeholders[type]}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea class="input" id="linkDesc" placeholder="–ó–∞–º–µ—Ç–∫–∞ –æ —Å—Å—ã–ª–∫–µ..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="App.saveLink()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `
        });
    }
    
    async saveLink() {
        const type = document.getElementById('linkType').value;
        const title = document.getElementById('linkTitle').value.trim();
        const url = document.getElementById('linkUrl').value.trim();
        const desc = document.getElementById('linkDesc').value.trim();
        
        if (!title || !url) {
            this.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ URL', 'error');
            return;
        }
        
        const link = {
            id: this.generateId(),
            tripId: this.currentTrip.id,
            type,
            title,
            url,
            description: desc
        };
        
        await this.dbSave('links', link);
        this.closeModal();
        this.showToast('üîó –°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
        this.renderTripDetail();
    }
    
    async openLink(linkId) {
        const link = await this.dbGet('links', linkId);
        if (!link) return;
        
        this.showModal({
            title: link.title,
            body: `
                ${link.description ? `<div class="description-block"><p class="description-text">${link.description}</p></div>` : ''}
                
                <a href="${link.url}" target="_blank" class="btn btn-primary mb-16">–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É ‚Üó</a>
                
                <button class="btn btn-danger" onclick="App.deleteLink('${linkId}')">–£–¥–∞–ª–∏—Ç—å</button>
            `
        });
    }
    
    async deleteLink(linkId) {
        await this.dbDelete('links', linkId);
        this.closeModal();
        this.showToast('üóëÔ∏è –°—Å—ã–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        this.renderTripDetail();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ó–ê–ú–ï–¢–ö–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderNotesTab() {
        const notes = await this.dbGetAll('notes', 'tripId', this.currentTrip.id);
        
        if (notes.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-title">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>
                    <div class="empty-text">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–µ–∑–¥–∫–µ</div>
                </div>
            `;
        }
        
        return `
            <div class="list">
                ${notes.map(n => `
                    <div class="list-item" onclick="App.showNoteDetail('${n.id}')">
                        <div class="list-item-icon note">üìù</div>
                        <div class="list-item-content">
                            <div class="list-item-title">${n.title}</div>
                            <div class="list-item-subtitle">${this.formatDate(n.created.split('T')[0])}</div>
                        </div>
                        <span class="list-item-arrow">‚Ä∫</span>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    showAddNoteModal() {
        this.showModal({
            title: '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞',
            body: `
                <div class="form-group">
                    <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" class="input" id="noteTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç</label>
                    <textarea class="input" id="noteText" rows="6" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="App.saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `
        });
    }
    
    async saveNote() {
        const title = document.getElementById('noteTitle').value.trim();
        const text = document.getElementById('noteText').value.trim();
        
        if (!title || !text) {
            this.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        const note = {
            id: this.generateId(),
            tripId: this.currentTrip.id,
            title,
            text,
            created: new Date().toISOString()
        };
        
        await this.dbSave('notes', note);
        this.closeModal();
        this.showToast('üìù –ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
        this.renderTripDetail();
    }
    
    async showNoteDetail(noteId) {
        const note = await this.dbGet('notes', noteId);
        if (!note) return;
        
        this.showModal({
            title: note.title,
            body: `
                <div class="description-block">
                    <p class="description-text">${note.text}</p>
                </div>
                
                <p class="text-secondary mb-16" style="font-size: 13px">
                    –°–æ–∑–¥–∞–Ω–æ: ${this.formatDateTime(note.created)}
                </p>
                
                <button class="btn btn-secondary mb-16" onclick="App.showEditNoteModal('${noteId}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                
                <button class="btn btn-danger" onclick="App.deleteNote('${noteId}')">–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
            `
        });
    }
    
    async showEditNoteModal(noteId) {
        const note = await this.dbGet('notes', noteId);
        if (!note) return;
        
        this.showModal({
            title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É',
            body: `
                <input type="hidden" id="editNoteId" value="${noteId}">
                
                <div class="form-group">
                    <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" class="input" id="editNoteTitle" value="${note.title}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç</label>
                    <textarea class="input" id="editNoteText" style="min-height: 150px;">${note.text}</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="App.updateNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `
        });
    }
    
    async updateNote() {
        const noteId = document.getElementById('editNoteId').value;
        const note = await this.dbGet('notes', noteId);
        if (!note) return;
        
        note.title = document.getElementById('editNoteTitle').value.trim();
        note.text = document.getElementById('editNoteText').value.trim();
        
        if (!note.title || !note.text) {
            this.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        await this.dbSave('notes', note);
        this.closeModal();
        this.showToast('‚úÖ –ó–∞–º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        this.renderTripDetail();
    }
    
    async deleteNote(noteId) {
        await this.dbDelete('notes', noteId);
        this.closeModal();
        this.showToast('üóëÔ∏è –ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        this.renderTripDetail();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –§–û–¢–û
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async renderPhotosTab() {
        const photos = await this.dbGetAll('photos', 'tripId', this.currentTrip.id);
        
        if (photos.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-icon">üì∑</div>
                    <div class="empty-title">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                    <div class="empty-text">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</div>
                </div>
            `;
        }
        
        return `
            <div class="photo-grid">
                ${photos.map(p => `
                    <div class="photo-item" onclick="App.showPhotoDetail('${p.id}')">
                        <img src="${p.data}" alt="">
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    addPhoto() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.multiple = true;
        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                const base64 = await this.fileToBase64(file);
                const photo = {
                    id: this.generateId(),
                    tripId: this.currentTrip.id,
                    data: base64,
                    created: new Date().toISOString()
                };
                await this.dbSave('photos', photo);
            }
            
            this.showToast(`üì∑ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ: ${files.length}`, 'success');
            this.renderTripDetail();
        };
        input.click();
    }
    
    async showPhotoDetail(photoId) {
        const photo = await this.dbGet('photos', photoId);
        if (!photo) return;
        
        this.showModal({
            title: '–§–æ—Ç–æ',
            body: `
                <img src="${photo.data}" style="width: 100%; border-radius: 12px; margin-bottom: 16px">
                
                <button class="btn btn-danger" onclick="App.deletePhoto('${photoId}')">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
            `
        });
    }
    
    async deletePhoto(photoId) {
        await this.dbDelete('photos', photoId);
        this.closeModal();
        this.showToast('üóëÔ∏è –§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
        this.renderTripDetail();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –ú–ï–ù–Æ –ü–û–ï–ó–î–ö–ò
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    showTripMenu() {
        this.showModal({
            title: '–î–µ–π—Å—Ç–≤–∏—è',
            body: `
                <div class="list">
                    <div class="list-item" onclick="App.editTrip()">
                        <div class="list-item-icon" style="background: #e3f2fd">‚úèÔ∏è</div>
                        <div class="list-item-content">
                            <div class="list-item-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                        </div>
                    </div>
                    <div class="list-item" onclick="App.exportTrip()">
                        <div class="list-item-icon" style="background: #e8f5e9">üì§</div>
                        <div class="list-item-content">
                            <div class="list-item-title">–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</div>
                            <div class="list-item-subtitle">–î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                        </div>
                    </div>
                    <div class="list-item" onclick="App.exportTripHTML()">
                        <div class="list-item-icon" style="background: #fff3e0">üåê</div>
                        <div class="list-item-content">
                            <div class="list-item-title">–≠–∫—Å–ø–æ—Ä—Ç –≤ HTML</div>
                            <div class="list-item-subtitle">–ö—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è Telegram</div>
                        </div>
                    </div>
                    <div class="list-item" onclick="App.deleteTrip()">
                        <div class="list-item-icon" style="background: #ffebee">üóëÔ∏è</div>
                        <div class="list-item-content">
                            <div class="list-item-title" style="color: var(--danger)">–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</div>
                        </div>
                    </div>
                </div>
            `
        });
    }
    
    async editTrip() {
        const trip = this.currentTrip;
        
        this.showModal({
            title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
            body: `
                <div class="cover-picker" id="coverPicker" onclick="App.pickCover()">
                    ${trip.cover 
                        ? `<img src="${trip.cover}"><div class="cover-picker-overlay"><span class="cover-picker-icon">üì∑</span><span class="cover-picker-text">–ò–∑–º–µ–Ω–∏—Ç—å</span></div>`
                        : `<span class="cover-picker-icon">üì∑</span><span class="cover-picker-text">–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É</span>`
                    }
                </div>
                <input type="hidden" id="tripCover" value="${trip.cover || ''}">
                ${trip.cover ? `<button type="button" class="btn btn-text" style="color: var(--danger); margin-bottom: 16px;" onclick="App.removeTripCover()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ–±–ª–æ–∂–∫—É</button>` : ''}
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="input" id="tripTitle" value="${trip.title}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input type="date" class="input" id="tripStart" value="${trip.startDate}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" class="input" id="tripEnd" value="${trip.endDate}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="input" id="tripDesc">${trip.description || ''}</textarea>
                </div>
                
                <button class="btn btn-primary" onclick="App.updateTrip()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `
        });
    }
    
    removeTripCover() {
        document.getElementById('tripCover').value = '';
        document.getElementById('coverPicker').innerHTML = `
            <span class="cover-picker-icon">üì∑</span>
            <span class="cover-picker-text">–î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É</span>
        `;
        // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
        const removeBtn = document.querySelector('.btn-text[onclick*="removeTripCover"]');
        if (removeBtn) removeBtn.remove();
        this.showToast('üóëÔ∏è –û–±–ª–æ–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    }
    
    async updateTrip() {
        const trip = this.currentTrip;
        
        trip.title = document.getElementById('tripTitle').value.trim();
        trip.startDate = document.getElementById('tripStart').value;
        trip.endDate = document.getElementById('tripEnd').value;
        trip.description = document.getElementById('tripDesc').value.trim();
        trip.cover = document.getElementById('tripCover').value || null;
        
        await this.dbSave('trips', trip);
        this.closeModal();
        this.showToast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
        this.updateHeader(trip.title, true, { text: '¬∑¬∑¬∑', onClick: () => this.showTripMenu() });
    }
    
    async deleteTrip() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) return;
        
        const tripId = this.currentTrip.id;
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const events = await this.dbGetAll('events', 'tripId', tripId);
        for (const e of events) await this.dbDelete('events', e.id);
        
        const links = await this.dbGetAll('links', 'tripId', tripId);
        for (const l of links) await this.dbDelete('links', l.id);
        
        const notes = await this.dbGetAll('notes', 'tripId', tripId);
        for (const n of notes) await this.dbDelete('notes', n.id);
        
        const photos = await this.dbGetAll('photos', 'tripId', tripId);
        for (const p of photos) await this.dbDelete('photos', p.id);
        
        await this.dbDelete('trips', tripId);
        
        this.closeModal();
        this.showToast('üóëÔ∏è –ü–æ–µ–∑–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        this.renderTrips();
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –≠–ö–°–ü–û–†–¢ / –ò–ú–ü–û–†–¢
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async exportTripHTML() {
        const trip = this.currentTrip;
        const tripId = trip.id;
        
        const events = await this.dbGetAll('events', 'tripId', tripId);
        const links = await this.dbGetAll('links', 'tripId', tripId);
        const notes = await this.dbGetAll('notes', 'tripId', tripId);
        const photos = await this.dbGetAll('photos', 'tripId', tripId);
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–∞—Ç–∞–º
        const groupedEvents = {};
        events.forEach(e => {
            if (!groupedEvents[e.date]) groupedEvents[e.date] = [];
            groupedEvents[e.date].push(e);
        });
        const sortedDates = Object.keys(groupedEvents).sort();
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å—Å—ã–ª–æ–∫ –ø–æ —Ç–∏–ø—É
        const linkTypes = { map: [], yandex: [], instagram: [], web: [] };
        links.forEach(l => {
            if (linkTypes[l.type]) linkTypes[l.type].push(l);
        });
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
        const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${trip.title}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 24px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header .dates {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .cover-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .day-block {
            margin-bottom: 20px;
        }
        
        .day-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .day-badge {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .day-badge .num { font-size: 20px; line-height: 1; }
        .day-badge .month { font-size: 10px; text-transform: uppercase; }
        
        .day-info .weekday { font-size: 17px; font-weight: 600; }
        .day-info .date { font-size: 13px; color: #8e8e93; }
        
        .event {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f5;
            display: flex;
            gap: 12px;
        }
        
        .event:last-child { border-bottom: none; }
        
        .event-time {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            width: 50px;
            flex-shrink: 0;
        }
        
        .event-content { flex: 1; }
        .event-title { font-size: 16px; font-weight: 500; }
        .event-note { font-size: 14px; color: #8e8e93; margin-top: 4px; }
        
        .event-photo {
            width: 100%;
            border-radius: 12px;
            margin-top: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .event-photo:hover {
            transform: scale(1.02);
        }
        
        .event-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding: 8px 14px;
            background: #f0f0f5;
            border-radius: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .event-link:hover { background: #e5e5ea; }
        
        .link-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: #f8f8fc;
            border-radius: 12px;
            margin-bottom: 8px;
            text-decoration: none;
            color: inherit;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .link-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .link-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .link-icon.map { background: #e8f5e9; }
        .link-icon.yandex { background: #fff3e0; }
        .link-icon.instagram { background: #fce4ec; }
        .link-icon.web { background: #e3f2fd; }
        
        .link-info { flex: 1; }
        .link-title { font-size: 16px; font-weight: 500; }
        .link-url { font-size: 12px; color: #8e8e93; }
        
        .note-item {
            padding: 16px;
            background: #fefce8;
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #fbbf24;
        }
        
        .note-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .note-text { font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .photo-item:hover {
            transform: scale(1.05);
        }
        
        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .subsection { margin-top: 16px; }
        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: #8e8e93;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .footer {
            text-align: center;
            color: white;
            opacity: 0.7;
            font-size: 14px;
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è ${trip.title}</h1>
            <div class="dates">${this.formatDateRange(trip.startDate, trip.endDate)}</div>
        </div>
        
        ${trip.cover ? `<img src="${trip.cover}" class="cover-image" alt="${trip.title}">` : ''}
        
        ${trip.description ? `
        <div class="section">
            <div class="section-title">üìã –û –ø–æ–µ–∑–¥–∫–µ</div>
            <p style="line-height: 1.6;">${trip.description}</p>
        </div>
        ` : ''}
        
        ${sortedDates.length > 0 ? `
        <div class="section">
            <div class="section-title">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
            ${sortedDates.map(date => {
                const d = new Date(date);
                const dayEvents = groupedEvents[date].sort((a, b) => a.time.localeCompare(b.time));
                return `
                <div class="day-block">
                    <div class="day-header">
                        <div class="day-badge">
                            <span class="num">${d.getDate()}</span>
                            <span class="month">${this.getMonthShort(d.getMonth())}</span>
                        </div>
                        <div class="day-info">
                            <div class="weekday">${this.getWeekday(d)}</div>
                            <div class="date">${this.formatDate(date)}</div>
                        </div>
                    </div>
                    ${dayEvents.map(e => `
                    <div class="event">
                        <span class="event-time">${e.time}</span>
                        <div class="event-content">
                            <div class="event-title">${e.title}</div>
                            ${e.note ? `<div class="event-note">${e.note}</div>` : ''}
                            ${e.link ? `<a href="${e.link}" target="_blank" class="event-link">üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</a>` : ''}
                            ${e.photo ? `<img src="${e.photo}" class="event-photo" onclick="openLightbox(this.src)" alt="${e.title}">` : ''}
                        </div>
                    </div>
                    `).join('')}
                </div>
                `;
            }).join('')}
        </div>
        ` : ''}
        
        ${links.length > 0 ? `
        <div class="section">
            <div class="section-title">üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏</div>
            
            ${linkTypes.map.length > 0 ? `
            <div class="subsection">
                <div class="subsection-title">üó∫Ô∏è Google Maps</div>
                ${linkTypes.map.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon map">üó∫Ô∏è</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                </a>
                `).join('')}
            </div>
            ` : ''}
            
            ${linkTypes.yandex.length > 0 ? `
            <div class="subsection">
                <div class="subsection-title">üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</div>
                ${linkTypes.yandex.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon yandex">üìç</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                </a>
                `).join('')}
            </div>
            ` : ''}
            
            ${linkTypes.instagram.length > 0 ? `
            <div class="subsection">
                <div class="subsection-title">üì∏ Instagram</div>
                ${linkTypes.instagram.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon instagram">üì∏</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                </a>
                `).join('')}
            </div>
            ` : ''}
            
            ${linkTypes.web.length > 0 ? `
            <div class="subsection">
                <div class="subsection-title">üåê –°–∞–π—Ç—ã</div>
                ${linkTypes.web.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon web">üåê</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                </a>
                `).join('')}
            </div>
            ` : ''}
        </div>
        ` : ''}
        
        ${notes.length > 0 ? `
        <div class="section">
            <div class="section-title">üìù –ó–∞–º–µ—Ç–∫–∏</div>
            ${notes.map(n => `
            <div class="note-item">
                <div class="note-title">${n.title}</div>
                <div class="note-text">${n.text}</div>
            </div>
            `).join('')}
        </div>
        ` : ''}
        
        ${photos.length > 0 ? `
        <div class="section">
            <div class="section-title">üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
            <div class="photo-grid">
                ${photos.map(p => `<img src="${p.data}" class="photo-item" onclick="openLightbox(this.src)" alt="–§–æ—Ç–æ">`).join('')}
            </div>
        </div>
        ` : ''}
        
        <div class="footer">
            –°–æ–∑–¥–∞–Ω–æ –≤ Trip Planner ‚Ä¢ ${new Date().toLocaleDateString('ru-RU')}
        </div>
    </div>
    
    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
        <img id="lightboxImg" src="" alt="">
    </div>
    
    <script>
        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
    </script>
</body>
</html>`;
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${trip.title.replace(/\s+/g, '_')}.html`;
        a.click();
        
        URL.revokeObjectURL(url);
        this.showToast('üåê HTML —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!', 'success');
    }
    
    async exportTrip() {
        const trip = this.currentTrip;
        const tripId = trip.id;
        
        const data = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            trip: trip,
            events: await this.dbGetAll('events', 'tripId', tripId),
            links: await this.dbGetAll('links', 'tripId', tripId),
            notes: await this.dbGetAll('notes', 'tripId', tripId),
            photos: await this.dbGetAll('photos', 'tripId', tripId)
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `trip_${trip.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        this.closeModal();
        this.showToast('üì§ –ü–æ–µ–∑–¥–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');
    }
    
    async exportTripHTML() {
        const trip = this.currentTrip;
        const tripId = trip.id;
        
        const events = await this.dbGetAll('events', 'tripId', tripId);
        const links = await this.dbGetAll('links', 'tripId', tripId);
        const notes = await this.dbGetAll('notes', 'tripId', tripId);
        const photos = await this.dbGetAll('photos', 'tripId', tripId);
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –¥–∞—Ç–∞–º
        const groupedEvents = {};
        events.forEach(e => {
            if (!groupedEvents[e.date]) groupedEvents[e.date] = [];
            groupedEvents[e.date].push(e);
        });
        const sortedDates = Object.keys(groupedEvents).sort();
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –ø–æ —Ç–∏–ø–∞–º
        const linksByType = {
            map: links.filter(l => l.type === 'map'),
            yandex: links.filter(l => l.type === 'yandex'),
            instagram: links.filter(l => l.type === 'instagram'),
            web: links.filter(l => l.type === 'web')
        };
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
        const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${trip.title} ‚Äî Trip Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #8e8e93;
            --accent: #007aff;
            --border: #e5e5ea;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding-bottom: 40px;
        }
        
        .hero {
            background: ${trip.cover ? `url('${trip.cover}') center/cover` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
            min-height: 220px;
            display: flex;
            align-items: flex-end;
            padding: 20px;
            position: relative;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(transparent 40%, rgba(0,0,0,0.7));
        }
        
        .hero-content {
            position: relative;
            color: white;
            width: 100%;
        }
        
        .hero-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .hero-dates {
            font-size: 16px;
            opacity: 0.95;
        }
        
        .hero-emoji {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }
        
        .section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 12px;
        }
        
        .day-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #007aff, #5856d6);
            color: white;
        }
        
        .day-date {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
        }
        
        .day-num {
            font-size: 22px;
            font-weight: 700;
            line-height: 1;
        }
        
        .day-month {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.9;
        }
        
        .day-info .weekday {
            font-size: 17px;
            font-weight: 600;
        }
        
        .day-info .full-date {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .event {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        
        .event:last-child {
            border-bottom: none;
        }
        
        .event-time {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent);
            min-width: 50px;
        }
        
        .event-content {
            flex: 1;
        }
        
        .event-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .event-note {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .event-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--bg);
            border-radius: 8px;
            color: var(--accent);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }
        
        .event-link:active {
            opacity: 0.7;
        }
        
        .event-photo {
            width: 100%;
            max-width: 300px;
            border-radius: 12px;
            margin-top: 10px;
        }
        
        .link-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            text-decoration: none;
            color: inherit;
            transition: background 0.15s;
        }
        
        .link-item:last-child {
            border-bottom: none;
        }
        
        .link-item:active {
            background: var(--bg);
        }
        
        .link-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }
        
        .link-icon.map { background: #e8f5e9; }
        .link-icon.yandex { background: #fff3e0; }
        .link-icon.instagram { background: #fce4ec; }
        .link-icon.web { background: #e3f2fd; }
        
        .link-info {
            flex: 1;
        }
        
        .link-title {
            font-size: 16px;
            font-weight: 500;
        }
        
        .link-url {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .link-arrow {
            color: var(--text-secondary);
            font-size: 18px;
        }
        
        .note-card {
            padding: 16px;
        }
        
        .note-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .note-text {
            font-size: 15px;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            width: 100%;
        }
        
        .subsection {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 10px 4px;
        }
        
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .footer a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .description {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="hero">
        ${!trip.cover ? `<div class="hero-content" style="text-align: center; padding-bottom: 20px;"><div class="hero-emoji">${this.getTripEmoji(trip.title)}</div></div>` : ''}
        <div class="hero-content">
            <h1 class="hero-title">${trip.title}</h1>
            <div class="hero-dates">${this.formatDateRange(trip.startDate, trip.endDate)}</div>
        </div>
    </div>
    
    <div class="container">
        ${trip.description ? `<div class="description">${trip.description}</div>` : ''}
        
        ${events.length > 0 ? `
        <div class="section">
            <h2 class="section-title">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
            ${sortedDates.map(date => {
                const dateObj = new Date(date);
                const dayEvents = groupedEvents[date].sort((a, b) => a.time.localeCompare(b.time));
                return `
                <div class="card">
                    <div class="day-header">
                        <div class="day-date">
                            <span class="day-num">${dateObj.getDate()}</span>
                            <span class="day-month">${this.getMonthShort(dateObj.getMonth())}</span>
                        </div>
                        <div class="day-info">
                            <div class="weekday">${this.getWeekday(dateObj)}</div>
                            <div class="full-date">${this.formatDate(date)}</div>
                        </div>
                    </div>
                    ${dayEvents.map(e => `
                    <div class="event">
                        <span class="event-time">${e.time}</span>
                        <div class="event-content">
                            <div class="event-title">${e.title}</div>
                            ${e.note ? `<div class="event-note">${e.note}</div>` : ''}
                            ${e.link ? `<a href="${e.link}" target="_blank" class="event-link">${e.link.includes('yandex') ? 'üìç' : 'üó∫Ô∏è'} –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>` : ''}
                            ${e.photo ? `<img src="${e.photo}" class="event-photo" alt="">` : ''}
                        </div>
                    </div>
                    `).join('')}
                </div>
                `;
            }).join('')}
        </div>
        ` : ''}
        
        ${links.length > 0 ? `
        <div class="section">
            <h2 class="section-title">üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h2>
            
            ${linksByType.map.length > 0 ? `
            <div class="subsection">üó∫Ô∏è Google Maps</div>
            <div class="card">
                ${linksByType.map.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon map">üó∫Ô∏è</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                    <span class="link-arrow">‚Ä∫</span>
                </a>
                `).join('')}
            </div>
            ` : ''}
            
            ${linksByType.yandex.length > 0 ? `
            <div class="subsection">üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</div>
            <div class="card">
                ${linksByType.yandex.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon yandex">üìç</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                    <span class="link-arrow">‚Ä∫</span>
                </a>
                `).join('')}
            </div>
            ` : ''}
            
            ${linksByType.instagram.length > 0 ? `
            <div class="subsection">üì∏ Instagram</div>
            <div class="card">
                ${linksByType.instagram.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon instagram">üì∏</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                    <span class="link-arrow">‚Ä∫</span>
                </a>
                `).join('')}
            </div>
            ` : ''}
            
            ${linksByType.web.length > 0 ? `
            <div class="subsection">üåê –°–∞–π—Ç—ã</div>
            <div class="card">
                ${linksByType.web.map(l => `
                <a href="${l.url}" target="_blank" class="link-item">
                    <div class="link-icon web">üåê</div>
                    <div class="link-info">
                        <div class="link-title">${l.title}</div>
                        <div class="link-url">${this.getDomain(l.url)}</div>
                    </div>
                    <span class="link-arrow">‚Ä∫</span>
                </a>
                `).join('')}
            </div>
            ` : ''}
        </div>
        ` : ''}
        
        ${notes.length > 0 ? `
        <div class="section">
            <h2 class="section-title">üìù –ó–∞–º–µ—Ç–∫–∏</h2>
            ${notes.map(n => `
            <div class="card note-card">
                <div class="note-title">${n.title}</div>
                <div class="note-text">${n.text}</div>
            </div>
            `).join('')}
        </div>
        ` : ''}
        
        ${photos.length > 0 ? `
        <div class="section">
            <h2 class="section-title">üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
            <div class="card" style="padding: 8px;">
                <div class="photo-grid">
                    ${photos.map(p => `<img src="${p.data}" class="photo-item" alt="">`).join('')}
                </div>
            </div>
        </div>
        ` : ''}
        
        <div class="footer">
            –°–æ–∑–¥–∞–Ω–æ –≤ <a href="#">Trip Planner</a><br>
            ${new Date().toLocaleDateString('ru-RU')}
        </div>
    </div>
</body>
</html>`;
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${trip.title.replace(/\s+/g, '_')}.html`;
        a.click();
        
        URL.revokeObjectURL(url);
        this.closeModal();
        this.showToast('üåê HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
    }
    
    async exportAllData() {
        const trips = await this.dbGetAll('trips');
        const allData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            trips: []
        };
        
        for (const trip of trips) {
            allData.trips.push({
                trip: trip,
                events: await this.dbGetAll('events', 'tripId', trip.id),
                links: await this.dbGetAll('links', 'tripId', trip.id),
                notes: await this.dbGetAll('notes', 'tripId', trip.id),
                photos: await this.dbGetAll('photos', 'tripId', trip.id)
            });
        }
        
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `tripplanner_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        this.showToast('üì§ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    }
    
    async exportTripHTML() {
        const trip = this.currentTrip;
        const tripId = trip.id;
        
        const events = await this.dbGetAll('events', 'tripId', tripId);
        const links = await this.dbGetAll('links', 'tripId', tripId);
        const notes = await this.dbGetAll('notes', 'tripId', tripId);
        const photos = await this.dbGetAll('photos', 'tripId', tripId);
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–∞—Ç–∞–º
        const groupedEvents = {};
        events.forEach(e => {
            if (!groupedEvents[e.date]) groupedEvents[e.date] = [];
            groupedEvents[e.date].push(e);
        });
        const sortedDates = Object.keys(groupedEvents).sort();
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å—Å—ã–ª–æ–∫ –ø–æ —Ç–∏–ø—É
        const groupedLinks = {
            map: links.filter(l => l.type === 'map'),
            yandex: links.filter(l => l.type === 'yandex'),
            instagram: links.filter(l => l.type === 'instagram'),
            web: links.filter(l => l.type === 'web')
        };
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
        const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${trip.title}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #8e8e93;
            --accent: #007aff;
            --border: #e5e5ea;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Header */
        .hero {
            background: var(--card);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .hero-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
        }
        
        .hero-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .hero-content {
            padding: 20px;
            text-align: center;
        }
        
        .hero-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .hero-dates {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .hero-desc {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Sections */
        .section {
            background: var(--card);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            padding: 16px;
        }
        
        /* Day */
        .day {
            margin-bottom: 20px;
        }
        
        .day:last-child {
            margin-bottom: 0;
        }
        
        .day-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .day-badge {
            width: 50px;
            height: 50px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .day-badge-num {
            font-size: 20px;
            font-weight: 700;
            line-height: 1;
        }
        
        .day-badge-month {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .day-title {
            font-size: 17px;
            font-weight: 600;
        }
        
        .day-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Event */
        .event {
            background: var(--bg);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }
        
        .event:last-child {
            margin-bottom: 0;
        }
        
        .event-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .event-time {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            min-width: 50px;
        }
        
        .event-content {
            flex: 1;
        }
        
        .event-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .event-note {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .event-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--accent);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .event-link:hover {
            opacity: 0.9;
        }
        
        .event-photo {
            width: 100%;
            border-radius: 10px;
            margin-top: 12px;
        }
        
        /* Links */
        .link-group {
            margin-bottom: 16px;
        }
        
        .link-group:last-child {
            margin-bottom: 0;
        }
        
        .link-group-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-left: 4px;
        }
        
        .link-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 8px;
            text-decoration: none;
            color: var(--text);
            transition: transform 0.2s;
        }
        
        .link-item:hover {
            transform: scale(1.02);
        }
        
        .link-item:last-child {
            margin-bottom: 0;
        }
        
        .link-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .link-icon.map { background: #e8f5e9; }
        .link-icon.yandex { background: #fff3e0; }
        .link-icon.instagram { background: #fce4ec; }
        .link-icon.web { background: #e3f2fd; }
        
        .link-info {
            flex: 1;
            min-width: 0;
        }
        
        .link-title {
            font-size: 15px;
            font-weight: 500;
        }
        
        .link-url {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-arrow {
            color: var(--text-secondary);
            font-size: 18px;
        }
        
        /* Notes */
        .note {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .note:last-child {
            margin-bottom: 0;
        }
        
        .note-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .note-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        /* Photos */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
        }
        
        .footer a {
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero -->
        <div class="hero">
            <div class="hero-image">
                ${trip.cover ? `<img src="${trip.cover}" alt="${trip.title}">` : '‚úàÔ∏è'}
            </div>
            <div class="hero-content">
                <h1 class="hero-title">${trip.title}</h1>
                <div class="hero-dates">${this.formatDateRange(trip.startDate, trip.endDate)}</div>
                ${trip.description ? `<p class="hero-desc">${trip.description}</p>` : ''}
            </div>
        </div>
        
        ${sortedDates.length > 0 ? `
        <!-- Schedule -->
        <div class="section">
            <div class="section-header">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="section-content">
                ${sortedDates.map(date => {
                    const dayEvents = groupedEvents[date].sort((a, b) => a.time.localeCompare(b.time));
                    const d = new Date(date);
                    const weekdays = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
                    const months = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
                    
                    return `
                        <div class="day">
                            <div class="day-header">
                                <div class="day-badge">
                                    <span class="day-badge-num">${d.getDate()}</span>
                                    <span class="day-badge-month">${months[d.getMonth()]}</span>
                                </div>
                                <div>
                                    <div class="day-title">${weekdays[d.getDay()]}</div>
                                    <div class="day-subtitle">${d.toLocaleDateString('ru-RU')}</div>
                                </div>
                            </div>
                            ${dayEvents.map(e => `
                                <div class="event">
                                    <div class="event-header">
                                        <span class="event-time">${e.time}</span>
                                        <div class="event-content">
                                            <div class="event-title">${e.title}</div>
                                            ${e.note ? `<div class="event-note">${e.note}</div>` : ''}
                                            ${e.link ? `<a href="${e.link}" target="_blank" class="event-link">${e.link.includes('yandex') ? 'üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã' : e.link.includes('google') || e.link.includes('goo.gl') ? 'üó∫Ô∏è Google Maps' : 'üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É'}</a>` : ''}
                                        </div>
                                    </div>
                                    ${e.photo ? `<img src="${e.photo}" class="event-photo" alt="">` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        ` : ''}
        
        ${links.length > 0 ? `
        <!-- Links -->
        <div class="section">
            <div class="section-header">üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏</div>
            <div class="section-content">
                ${groupedLinks.map.length > 0 ? `
                    <div class="link-group">
                        <div class="link-group-title">üó∫Ô∏è Google Maps</div>
                        ${groupedLinks.map.map(l => `
                            <a href="${l.url}" target="_blank" class="link-item">
                                <div class="link-icon map">üó∫Ô∏è</div>
                                <div class="link-info">
                                    <div class="link-title">${l.title}</div>
                                    <div class="link-url">${l.url}</div>
                                </div>
                                <span class="link-arrow">‚Ä∫</span>
                            </a>
                        `).join('')}
                    </div>
                ` : ''}
                ${groupedLinks.yandex.length > 0 ? `
                    <div class="link-group">
                        <div class="link-group-title">üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</div>
                        ${groupedLinks.yandex.map(l => `
                            <a href="${l.url}" target="_blank" class="link-item">
                                <div class="link-icon yandex">üìç</div>
                                <div class="link-info">
                                    <div class="link-title">${l.title}</div>
                                    <div class="link-url">${l.url}</div>
                                </div>
                                <span class="link-arrow">‚Ä∫</span>
                            </a>
                        `).join('')}
                    </div>
                ` : ''}
                ${groupedLinks.instagram.length > 0 ? `
                    <div class="link-group">
                        <div class="link-group-title">üì∏ Instagram</div>
                        ${groupedLinks.instagram.map(l => `
                            <a href="${l.url}" target="_blank" class="link-item">
                                <div class="link-icon instagram">üì∏</div>
                                <div class="link-info">
                                    <div class="link-title">${l.title}</div>
                                    <div class="link-url">${l.url}</div>
                                </div>
                                <span class="link-arrow">‚Ä∫</span>
                            </a>
                        `).join('')}
                    </div>
                ` : ''}
                ${groupedLinks.web.length > 0 ? `
                    <div class="link-group">
                        <div class="link-group-title">üåê –°–∞–π—Ç—ã</div>
                        ${groupedLinks.web.map(l => `
                            <a href="${l.url}" target="_blank" class="link-item">
                                <div class="link-icon web">üåê</div>
                                <div class="link-info">
                                    <div class="link-title">${l.title}</div>
                                    <div class="link-url">${l.url}</div>
                                </div>
                                <span class="link-arrow">‚Ä∫</span>
                            </a>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
        ` : ''}
        
        ${notes.length > 0 ? `
        <!-- Notes -->
        <div class="section">
            <div class="section-header">üìù –ó–∞–º–µ—Ç–∫–∏</div>
            <div class="section-content">
                ${notes.map(n => `
                    <div class="note">
                        <div class="note-title">${n.title}</div>
                        <div class="note-text">${n.text}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        ${photos.length > 0 ? `
        <!-- Photos -->
        <div class="section">
            <div class="section-header">üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
            <div class="section-content">
                <div class="photo-grid">
                    ${photos.map(p => `
                        <div class="photo-item">
                            <img src="${p.data}" alt="">
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        ` : ''}
        
        <div class="footer">
            –°–æ–∑–¥–∞–Ω–æ –≤ Trip Planner ‚Ä¢ ${new Date().toLocaleDateString('ru-RU')}
        </div>
    </div>
</body>
</html>`;
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${trip.title.replace(/\s+/g, '_')}.html`;
        a.click();
        
        URL.revokeObjectURL(url);
        this.closeModal();
        this.showToast('üåê HTML —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
    }
    
    importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (data.trips) {
                    // –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø
                    for (const item of data.trips) {
                        await this.importTripData(item);
                    }
                } else if (data.trip) {
                    // –û–¥–Ω–∞ –ø–æ–µ–∑–¥–∫–∞
                    await this.importTripData(data);
                }
                
                this.showToast('üì• –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                this.renderTrips();
            } catch (error) {
                console.error(error);
                this.showToast('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', 'error');
            }
        };
        input.click();
    }
    
    async importTripData(data) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ ID —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        const oldTripId = data.trip.id;
        const newTripId = this.generateId();
        
        data.trip.id = newTripId;
        await this.dbSave('trips', data.trip);
        
        for (const event of (data.events || [])) {
            event.id = this.generateId();
            event.tripId = newTripId;
            await this.dbSave('events', event);
        }
        
        for (const link of (data.links || [])) {
            link.id = this.generateId();
            link.tripId = newTripId;
            await this.dbSave('links', link);
        }
        
        for (const note of (data.notes || [])) {
            note.id = this.generateId();
            note.tripId = newTripId;
            await this.dbSave('notes', note);
        }
        
        for (const photo of (data.photos || [])) {
            photo.id = this.generateId();
            photo.tripId = newTripId;
            await this.dbSave('photos', photo);
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UI –ö–û–ú–ü–û–ù–ï–ù–¢–´
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    showModal(content) {
        this.dom.modalContent.innerHTML = `
            <div class="modal-handle"></div>
            <div class="modal-header">
                <span class="modal-title">${content.title || ''}</span>
                <button class="modal-close" onclick="App.closeModal()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
            <div class="modal-body">${content.body || ''}</div>
        `;
        this.dom.modal.classList.add('active');
    }
    
    closeModal() {
        this.dom.modal.classList.remove('active');
    }
    
    showToast(message, type = 'info') {
        this.dom.toast.textContent = message;
        this.dom.toast.className = `toast ${type} show`;
        setTimeout(() => this.dom.toast.classList.remove('show'), 3000);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –£–¢–ò–õ–ò–¢–´
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    
    formatDateTime(isoStr) {
        const date = new Date(isoStr);
        return date.toLocaleDateString('ru-RU', { 
            day: 'numeric', month: 'long', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }
    
    formatDateRange(start, end) {
        const s = new Date(start);
        const e = new Date(end);
        
        const sMonth = s.toLocaleDateString('ru-RU', { month: 'short' });
        const eMonth = e.toLocaleDateString('ru-RU', { month: 'short' });
        
        if (s.getMonth() === e.getMonth() && s.getFullYear() === e.getFullYear()) {
            return `${s.getDate()} ‚Äì ${e.getDate()} ${sMonth} ${s.getFullYear()}`;
        }
        
        return `${s.getDate()} ${sMonth} ‚Äì ${e.getDate()} ${eMonth} ${s.getFullYear()}`;
    }
    
    getMonthShort(month) {
        const months = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
        return months[month];
    }
    
    getWeekday(date) {
        const days = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
        return days[date.getDay()];
    }
    
    getDomain(url) {
        try {
            return new URL(url).hostname;
        } catch {
            return url;
        }
    }
    
    async fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
                .catch(err => console.log('Service Worker –æ—à–∏–±–∫–∞:', err));
        }
    }
}

// –ó–∞–ø—É—Å–∫
const App = new TripPlannerApp();
document.addEventListener('DOMContentLoaded', () => App.init());
window.App = App;
</script>
</body>
</html>
